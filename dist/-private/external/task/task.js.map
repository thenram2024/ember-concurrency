{"version":3,"file":"task.js","sources":["../../../../src/-private/external/task/task.js"],"sourcesContent":["import { Taskable } from './taskable';\nimport {\n  PERFORM_TYPE_DEFAULT,\n  PERFORM_TYPE_LINKED,\n  PERFORM_TYPE_UNLINKED,\n  getRunningInstance,\n  TaskInstanceExecutor,\n} from '../task-instance/executor';\n\nclass TaskLinkProxy {\n  constructor(task, performType, linkedObject) {\n    this.task = task;\n    this.performType = performType;\n    this.linkedObject = linkedObject;\n  }\n\n  perform(...args) {\n    return this.task._performShared(args, this.performType, this.linkedObject);\n  }\n}\n\nexport class Task extends Taskable {\n  constructor(options) {\n    super(options);\n    this.generatorFactory = options.generatorFactory;\n    this.perform = this._perform.bind(this);\n  }\n\n  linked() {\n    let linkedObject = getRunningInstance();\n    if (!linkedObject) {\n      throw new Error(`You can only call .linked() from within a task.`);\n    }\n\n    return new TaskLinkProxy(this, PERFORM_TYPE_LINKED, linkedObject);\n  }\n\n  unlinked() {\n    return new TaskLinkProxy(this, PERFORM_TYPE_UNLINKED, null);\n  }\n\n  toString() {\n    return `<Task:${this.name}>`;\n  }\n\n  _clone() {\n    return new Task({\n      context: this.context,\n      debug: this.debug,\n      env: this.env,\n      generatorFactory: this.generatorFactory,\n      group: this.group,\n      hasEnabledEvents: this.hasEnabledEvents,\n      name: this.name,\n      onStateCallback: this.onStateCallback,\n      scheduler: this.scheduler,\n    });\n  }\n\n  _curry(...args) {\n    let task = this._clone();\n    task._curryArgs = [...(this._curryArgs || []), ...args];\n    return task;\n  }\n\n  _perform(...args) {\n    return this._performShared(args, PERFORM_TYPE_DEFAULT, null);\n  }\n\n  _performShared(args, performType, linkedObject) {\n    let fullArgs = this._curryArgs ? [...this._curryArgs, ...args] : args;\n    let taskInstance = this._taskInstanceFactory(\n      fullArgs,\n      performType,\n      linkedObject,\n    );\n\n    if (performType === PERFORM_TYPE_LINKED) {\n      linkedObject._expectsLinkedYield = true;\n    }\n\n    if (!this._isAlive) {\n      // a task linked to a dead lifetime should immediately cancel.\n      taskInstance.cancel();\n    }\n\n    this.scheduler.perform(taskInstance);\n    return taskInstance;\n  }\n\n  // eslint-disable-next-line no-unused-vars\n  _taskInstanceOptions(args, performType, _linkedObject) {\n    let generatorFactory = () => this.generatorFactory(args);\n    let taskInstanceOptions = {\n      task: this,\n      args,\n      executor: new TaskInstanceExecutor({\n        generatorFactory,\n        env: this.env,\n        debug: this.debug,\n      }),\n      performType,\n      hasEnabledEvents: this.hasEnabledEvents,\n    };\n\n    return taskInstanceOptions;\n  }\n}\n"],"names":["TaskLinkProxy","constructor","task","performType","linkedObject","perform","args","_performShared","Task","Taskable","options","generatorFactory","_perform","bind","linked","getRunningInstance","Error","PERFORM_TYPE_LINKED","unlinked","PERFORM_TYPE_UNLINKED","toString","name","_clone","context","debug","env","group","hasEnabledEvents","onStateCallback","scheduler","_curry","_curryArgs","PERFORM_TYPE_DEFAULT","fullArgs","taskInstance","_taskInstanceFactory","_expectsLinkedYield","_isAlive","cancel","_taskInstanceOptions","_linkedObject","taskInstanceOptions","executor","TaskInstanceExecutor"],"mappings":"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"}